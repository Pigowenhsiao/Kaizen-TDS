# 🧣 Kaizen TDS Constitution

**Specification-Driven Architecture for CVD/GRATING Systems**
Version: 1.0
Author: Kaizen TDS Team
Date: 2025-11-03

---

## 1️⃣ Core Philosophy （核心理念）

> 「所有功能皆以設定為驅動，所有邏輯皆以資料為中心。」

* 禁止在程式中硬編常數或欄位名稱。
* 所有可變參數必須外部化至 `.ini` 設定檔。
* 所有輸出（CSV / XML / Log）必須具備時間戳或 UUID，以確保可追溯性。
* 系統應可無人值守自動執行，所有錯誤須被完整記錄並回報。

---

## 2️⃣ Layered Architecture （分層架構）

| Layer              | 模組範例                | 責任說明                                            |
| ------------------ | ------------------- | ----------------------------------------------- |
| **Config Layer**   | `config_loader.py`  | 使用 `configparser` 載入 `.ini`，並驗證欄位與型別。           |
| **Logging Layer**  | `logger_manager.py` | 實作 `logging` + `RotatingFileHandler`，統一格式與分檔機制。 |
| **Data Layer**     | `data_processor.py` | 使用 `pandas` 進行向量化清淨、過濾、轉換。                      |
| **IO Layer**       | `file_handler.py`   | 處理 Excel / CSV / XML 的讀寫、備份、命名。                 |
| **Database Layer** | `sql_adapter.py`    | 封裝 SQL Server 連線、查詢與關閉。                         |
| **Core Layer**     | `049_TAK_PLX.py`    | 主流程控制與模組協作，程式入口點。                               |

---

## 3️⃣ Config Management （設定管理）

* 所有邏輯均以 `.ini` 檔駕動，不可於程式中寫死條件。

* `.ini` 檔應包含以下區段：

  * `[Basic_info]`：任務屬性與資料保留天數。
  * `[Paths]`：I/O 路徑與記錄檔位置。
  * `[Excel]`：工作表名稱、欄位範圍與略過列數。
  * `[Database]`：SQL 連線資訊。
  * `[DataFields]`：Excel 欄位對應與資料型別定義。
  * `[XML_Defaults]`：XML 生成預設值。

* 載入設定後需轉為 `dataclass` 結構，並具備明確型別註解。

* 缺失欄位需產生日記警告，但不得中斷執行。

---

## 4️⃣ Logging & Traceability （日誌與可追蹤性）

* 使用 Python 標準模組 `logging` + `RotatingFileHandler`：

  * 單檔最大 5 MB，或每日自動分檔。
  * 日誌路徑：`../Log/YYYY-MM-DD/`
* 日誌格式：

  ```
  [YYYY-MM-DD HH:MM:SS] [LEVEL] message
  ```
* 每次執行皆建立新檔案，以 `Operation` 命名。
* 所有例外（I/O、SQL、轉型）必須完整 traceback 並記錄。
* 所有輸出檔案（CSV / XML）名稱需包含：

  * 時間戳 (`YYYYMMDD_HHMMSS`)，或
  * UUIDv4 以確保唯一性。

---

## 5️⃣ Data Validation & Vectorization （資料驗證與向量化）

* 數值欄位：`pd.to_numeric(..., errors="coerce")`
* 日期欄位：`pd.to_datetime(..., errors="coerce")`
* 禁止逐列迴圈（`for row in df.iterrows()`），需使用向量化處理：
  `assign()`, `apply()`, `map()`, `where()`, `loc[]`
* 缺失資料須記錄警告，並跳過該筆處理。

---

## 6️⃣ Database Interaction （資料庫介面）

* 以 `pyodbc` 或 `SQLAlchemy` 進行連線。
* 連線字串與帳號密碼皆由 `.ini` 設定。
* 每次查詢透過封裝函式進行，例如：

```python
def query_serial_info(serial_no: str) -> dict:
    """Return PartNumber, LotNumber for the given Serial."""
```

* 使用 `with` 或 `try/finally` 確保連線關閉。
* 查詢失敗須記錄警告但不中斷後續處理。

---

## 7️⃣ Output Policy （輸出策略）

| 類型              | 格式             | 說明                    |
| --------------- | -------------- | --------------------- |
| **CSV**         | UTF-8 with BOM | 含欄位轉換、動態排序、主要鍵值。      |
| **XML Pointer** | Pretty XML     | 指向對應 CSV，用於 SPC 系統匯入。 |
| **Log**         | 純文字            | 詳述處理步驟、資料量、錯誤與結果。     |

---

## 8️⃣ Error Handling & Robustness （錯誤處理與健壯性）

* 所有關鍵區塊使用 `try/except`，錯誤內容記錄於日誌。
* 非致命錯誤（如 Excel 讀取失敗、SQL Timeout）不可中斷主流程。
* 當遇致命錯誤（設定檔遺失、結構錯誤）時：

  1. 記錄完整 traceback
  2. 標記任務狀態為「Failed」
  3. 結束該任務但不中斷其他任務。

---

## 9️⃣ Type Hinting & Documentation （型別提示與文件化）

```python
def write_to_csv(path: str, df: pd.DataFrame) -> bool:
    """
    將資料寫入 CSV 檔案。
    Write processed DataFrame to CSV file.
    """
```

* 程式須通過以下檢查：

  * `flake8`（PEP8 格式檢查）
  * `mypy --strict`（型別檢查）

---

## 🕰️ Testing & Extensibility （測試與擴充性）

* 每個模組應具備對應單元測試（使用 `pytest`）。
* 外部依賴（DB、Excel）需可以 Mock 或 Dummy 資料模擬。
* 新增 Operation 或測試站時，只需新增 `.ini` 檔案，主程式不應修改。
* 測試覆蓋率應達 **80% 以上**。

---
# 🧭 Kaizen TDS Constitution

**Specification-Driven Architecture for CVD/GRATING Systems**
Version: 1.0
Author: Kaizen TDS Team
Date: 2025-11-03

---

## 📁 Recommended Project Structure

```
Kaizen_TDS/
│
├── config/
│   ├── Config_GRATING_Crystal_Duty.ini
│   └── Config_TEMPLATE.ini
│
├── core/
│   └── 049_TAK_PLX.py
│
├── modules/
│   ├── config_loader.py
│   ├── logger_manager.py
│   ├── data_processor.py
│   ├── file_handler.py
│   ├── sql_adapter.py
│   └── xml_generator.py
│
├── log/
│   └── (auto-generated by date)
│
├── data/
│   └── (Excel/CSV intermediate files)
│
└── tests/
    └── test_data_processor.py
```

---

## 🧩 Design Motto

> 「程式不是用來執行一次，而是為了在任何環境中持續可重現。」

* 所有邏輯須可追蹤、可重現、可審計。
* 設計重點：**模組化、外部化、日誌化、向量化、型別化。**

---

## 🧪 Implementation Guidelines

1. **模組化開發**

   * 每個模組獨立開發與測試，不得直接交叉依賴。
   * 僅透過主程式 (`049_TAK_PLX.py`) 整合執行。

2. **設定導向架構**

   * 所有可變邏輯（欄位、資料夾、DB 連線等）均從 `.ini` 匯入。
   * 模組內不應硬編路徑或名稱。

3. **資料完整性驗證**

   * 在每次讀取與寫入前後皆須進行資料筆數與欄位檢查。
   * 如筆數不符或缺欄，應記錄警告但不中斷流程。

4. **XML 與 CSV 對應性**

   * 每一個輸出 CSV 對應一份 XML pointer。
   * XML 名稱須包含：Site、Operation、SerialNumber、Timestamp。

5. **時間與唯一性**

   * 所有檔案命名遵循：`<Operation>_<YYYYMMDD_HHMMSS>_<UUID6>.ext`。
   * Log 與輸出路徑應自動建立日期目錄。

6. **資料追蹤與回朔機制**

   * 每筆資料應可從 Log → CSV → XML 追蹤至原始 Excel。
   * 若發現資料錯誤，Log 應標示對應檔名與行號。

7. **錯誤分級處理**

   * `INFO`：常規流程訊息。
   * `WARNING`：非致命異常（略過筆數、缺欄位）。
   * `ERROR`：致命錯誤（中止該檔案處理）。
   * `CRITICAL`：系統級錯誤（中止整體執行）。

---

## 🧱 Deployment & Maintenance

* **版本控制**：所有 Python 檔案與設定檔皆須納入 Git 管理。
* **自動化排程**：可透過 Windows Task Scheduler 或 Airflow 觸發。
* **日誌留存期限**：建議 90 天後自動壓縮或刪除。
* **錯誤通報**：Log 可擴充 SMTP 通知機制。
* **安全性**：機密資料（帳號、密碼）須以環境變數或加密存放。

---

## 🧬 Future Evolution

* 支援更多資料來源（SQLAlchemy ORM、REST API）。
* 導入 Pydantic 進行設定與資料驗證。
* 使用 pytest + coverage 自動生成測試報告。
* 規劃 CI/CD Pipeline（GitHub Actions / Jenkins）。

---

## 📜 License & Credits

This Constitution and its derived framework are licensed under the **Kaizen Internal Use Agreement**.
Developed by **Kaizen TDS Python Team**, 2025.

---

*This constitution defines the foundation for all Kaizen TDS Python systems.
Any new module or script must comply with these rules to ensure maintainability, reliability, and traceability.*
